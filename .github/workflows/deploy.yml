name: Deploy Monitoring To EC2 with Docker

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, closed]
    paths:
      - 'src/**'
      - 'build.gradle'
      - '.github/workflows/**'

jobs:
  Check_Path:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Check for changes
        id: check
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin main
            CHANGED_FILES=$(git diff --name-only origin/main..HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD^1 HEAD)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          if echo "$CHANGED_FILES" | grep -q -E "^(src/|build.gradle|.github/workflows/)"; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  Build:
    needs: Check_Path
    if: needs.Check_Path.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v3
        with:
          name: monitoring-jar
          path: build/libs/monitoring-1.0.0.jar

  Deploy:
    needs: [Check_Path, Build]
    if: |
      needs.Check_Path.outputs.should_deploy == 'true' && 
      (github.ref == 'refs/heads/main' || 
       (github.event_name == 'pull_request' && 
        github.event.action == 'closed' && 
        github.event.pull_request.merged == true))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download JAR artifact
        uses: actions/download-artifact@v3
        with:
          name: monitoring-jar
          path: build/libs/

      - name: Deploy JAR to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: ${{ secrets.REMOTE_SSH_PORT }}
          source: "build/libs/monitoring-1.0.0.jar"
          target: "/home/ubuntu/MonitoringProject/"
          strip_components: 2

      - name: Deploy to EC2 with Docker
        uses: appleboy/ssh-action@v1.0.3
        env:
          APPLICATION_YML: ${{ secrets.MONITORING_APPLICATION_YML }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: ${{ secrets.REMOTE_SSH_PORT }}
          envs: APPLICATION_YML
          script: |
            # 프로젝트 디렉토리로 이동
            cd /home/ubuntu/MonitoringProject
            
            # application.yml 생성
            mkdir -p src/main/resources
            echo "$APPLICATION_YML" > src/main/resources/application.yml
            
            # Dockerfile 확인 (없으면 생성)
            if [ ! -f Dockerfile ]; then
              echo "Creating Dockerfile..."
              cat > Dockerfile << 'EOF'
            FROM eclipse-temurin:17-jre-alpine
            WORKDIR /app
            COPY build/libs/monitoring-1.0.0.jar app.jar
            EXPOSE 8081
            ENV SPRING_PROFILES_ACTIVE=prod
            ENTRYPOINT ["java", "-jar", "app.jar"]
            EOF
            fi
            
            # build/libs 디렉토리 확인
            mkdir -p build/libs
            
            # Docker 컨테이너 재시작
            cd /home/ubuntu/docker-project
            
            # 기존 컨테이너 중지 및 삭제
            docker-compose stop monitoring || true
            docker-compose rm -f monitoring || true
            
            # 이미지 삭제 (캐시 무력화)
            docker rmi $(docker images --filter=reference='docker-project_monitoring' -q) 2>/dev/null || true
            
            # 다시 빌드 및 시작
            docker-compose up -d --no-deps --build monitoring
            
            # 정리
            docker container prune -f
            docker image prune -f --filter "dangling=true"
            
            # 로그 확인
            echo "=== Deployment completed ==="
            docker-compose logs --tail=50 monitoring